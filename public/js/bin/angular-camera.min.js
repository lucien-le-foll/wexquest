"use strict";!function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.hasUserMedia=function(){return navigator.getMedia?!0:!1}}(),angular.module("webcam",[]).directive("webcam",function(){return{template:'<div class="webcam" ng-transclude></div>',restrict:"E",replace:!0,transclude:!0,scope:{onError:"&",onStream:"&",onStreaming:"&",placeholder:"=",cameraid:"=",config:"=channel"},link:function(a,b){var c=null,d=null,e=null;a.config=a.config||{};var f=function(a){a&&angular.element(a).remove()},g=function(){d&&"function"==typeof d.stop&&d.stop(),c&&delete c.src},h=function(b){if(d=b,navigator.mozGetUserMedia)c.mozSrcObject=b;else{var e=window.URL||window.webkitURL;c.src=e.createObjectURL(b)}c.play(),a.config.video=c,a.onStream&&a.onStream({stream:b})},i=function(b){f(e),console&&console.log&&console.log("The following error occured: ",b),a.onError&&a.onError({err:b})},j=function(){function d(b){for(var c=0;c!==b.length;++c){var d=b[c];"video"===d.kind&&l.push(d)}var e;e=a.cameraid?{video:{optional:[{sourceId:l[a.cameraid].id}]},audio:!1}:{video:!0,audio:!1},navigator.getMedia(e,h,i)}c=document.createElement("video"),c.setAttribute("class","webcam-live"),c.setAttribute("autoplay",""),b.append(c),a.placeholder&&(e=document.createElement("img"),e.setAttribute("class","webcam-loader"),e.src=a.placeholder,b.append(e));var g=!1,j=b.width=a.config.videoWidth||320,k=b.height=0;if(!window.hasUserMedia())return void i({code:-1,msg:"Browser does not support getUserMedia."});var l=[];if("undefined"!=typeof MediaStreamTrack)if("undefined"!=typeof MediaStreamTrack.getSources)MediaStreamTrack.getSources(d);else{var m={video:!0,audio:!1};navigator.getMedia(m,h,i)}c.addEventListener("canplay",function(){if(!g){var b=j/c.videoWidth;k=c.videoHeight*b||a.config.videoHeight,c.setAttribute("width",j),c.setAttribute("height",k),g=!0,a.config.video=c,f(e),a.onStreaming&&a.onStreaming()}},!1)},k=function(){g(),c.remove()};a.$on("$destroy",g),a.$on("START_WEBCAM",j),a.$on("STOP_WEBCAM",k),j()}}});
